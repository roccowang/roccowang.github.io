---
title: 常用操作
date: 2016-08-05 23:57:56
tags: 
  - 运维
  - Linux
---

介绍 Linux 下运维的常用操作 [参考](#References)
<!--more-->

# 一个网易的题目
![netease_family](/media/netease_family.png)


---

# References
[性能不好怎么办?对着清单撸一遍!][1]
[vmstat命令参数详解][2]
[Use vmstat to Monitor System Performance][3]

---

# 维护常用的命令
## General
- uptime #load averages
    - 除了uptime之外,w和top也有load average的输出
    - 前面的分别时现在时间,系统运行了多长时间,目前有多少登录用户
    - 后面的三个数字表示的是系统在过去的1分钟,5分钟和15分钟内的平均负载
    - 平均负载的意思,就是**整个系统**的平均活动进程数量(意思就是,要处以内核数量)
    - 按照网上的说法,每个CPU平均负载在4以下都是可以接受的,小于1的时候就说明还有空闲时间
    - 理想的长期负载在0.7左右
- dmesg | tail #kernel errors
    - 可以查看Linux内核的环形缓冲区(ring buffer)的信息
    - 利用-c选项可以在查看完了以后清空环形缓冲区
    - -s可以设定缓冲区大小
    - -r可以显示原始缓冲区, 比如, 不删除日志等级信息
- vmstat 1 #overall stats by time
    - vmstat n m每隔n秒刷新一次, 抓取m次以后停止抓取
    - 抓取的信息
        - proc 显示了进程相关信息
            - r 处于运行队列中的进程数目
            - b 处于不可中断睡眠状态的进程数目
        - memory 显示的东西和`free -m`一样
            - swpd      显示有多少内存被交换出去了
            - free      空闲内存的大小
            - buff      有多少内存已经被分配使用了
            - cache     已分配内存中有多少可以被交换或者释放
            - inact     不活动内存大小
            - active    活动内存大小
        - swap
            - si        每秒有多少内存被换进物理内存
            - so        每秒有多少内存被换出物理内存
        - io
            - bi        每秒有多少块从磁盘被读入
            - bo        每秒有多少块被写入磁盘
        - system
            - in        每秒的中断数量, 包括系统时钟产生的中断
            - cs        每秒上下文切换的次数
        - cpu 这一块的时间加起来总是100, 反映的是可用时间的百分比
            - us        非内核时间
            - sy        内核时间
            - id        空闲时间
            - wa        等待IO操作的时间
            - st        被虚拟机偷走的时间(stolen)
    - -d可以显示磁盘相关的信息
        - -D可以指定磁盘分区
    - -S指定显示单位, 默认是k, 小写是1000, 大写是1024
- mpstat -P ALL 1 #CPU balance
- pidstat 1 #process usage
- iostat -xz 1 #disk IO
- free -m #memory usage
- sar -n DEV 1 #network IO
- sar -n TCP, ETCP 1 #TCP stats
- top #check overview

## Disk
- iostat -xnz 1 #any disk io? if not stop looking
- vmstat 1 #is this swapping? or high sys time?
- df -h #are file systems nearly full?
- ext4slower 10 #zfs*, xfs*, etc slow file system io?
- bioslower 10 #if so, check disks
- ext4dist 1 #check distribution and rate
- biolatency 1 #if interesting check disks
- cat /sys/devices/.../ioerr_cnt #(if available) errors
- smartctl -l error /dev/sda #(if available) errors

## Network
- sar -n DEV,EDEV 1 #at interface limits? or use nicstat
- sar -n TCP,ETCP 1 #active/passive load, retransmit rate
- cat /etc/resolv.conf #DNS
- mpstat -P ALL 1 #high kernel time? single hot CPU?
- tcpretrans #what are the retransmits? state?
- tcpconnect #connecting to anything unexpected?
- tcpaccept #unexpected workload?
- netstat -rnv #any inefficient routes?
- check firewall config #anything blocking/throttling?
- netstat -s #play 252 metric pickup

## CPU
- uptime #load averages
- vmstat 1 #system-wide utilization, run q length
- mpstat -P ALL 1 #CPU balance
- pidstat 1 #per-process CPU
- CPU flame graph #CPU profiling
- CPU subsecond offset heat map #look for gaps
- perf stat -a -- sleep 10 #IPC, LLC hit ratio

---

# 杂
- 查看启动日志

    ```
    tail /var/log/boot.log
    ```

- 查看消息

    ```
    tail /var/log/messages
    ```
    
- 修改HOSTNAME
- 显示系统信息

    ```
    uname -a
    ```
    
- 查看目录及占用空间

    ```
    du -h
    ```
    
- 查看在线用户

    ```
    who
    ```

- 查看当前终端

    ```
    tty
    ```
        
- 最大文件数

    ```
    ulimit -a
    ```
    
- 修改grub相关配置

    ```shell
    cat /boot/grub/grub.conf
    #这个就是grub的配置
    ```
    
- 临时更改一些系统参数可以根据`ulimit -a`的结果然后用`ulimit -n <xxx>`来更改
- `sysctl -a`可以查看内核参数,查看的其实是/etc/sysctl.conf文件
- 要修改参数的话就直接修改/etc/sysctl.conf然后用`sysctl -p`来通知系统更改
- 修改最大文件数
    - 可以在rc.local里面添加ulimit命令
- 一些常用的调优参数
    - buzhidao
- 查看磁盘使用量

    ```    
    -P用来保持同一行显示,方便脚本读取
    #可以再用column -t来保持方便查看
    df -Ph
    df -PhiT #查看inode相关信息
    df -PhiT -t vfat #筛选某个类型的磁盘 -x 则是反选
    ```
    
- 发现defunct进程以后怎么处理
    - 可以通过`ps -ef | grep defunct`来找到这些defunct进程的父进程,然后把父进程杀了
    - 可能和ctrl+z有关,当有job完成的时候可能需要`fg ID`一下才能释放,下午再查
    - 如果需要把jobs杀掉的话要用`kill %1`这种形式,然后就可以终止任务
- 查看jobs的PID

    ```
    jobs -ps
    ```
    
- 查看网络状态

    ```
    netstat -pn 可以把tcp按照状态分类
    netstat -pn| awk '/^tcp/{++S[$NF]} END {for (a in S) print a, S[a]}'    
    ```
    
- 查看端口占用

    ```
    netstat -tunpl
    ```
    
- 查看路由

    ```
    route -n
    ```
    
- arp查看机器上的ARP缓存

    ```
    arp 
    ```


[1]:https://mp.weixin.qq.com/s?__biz=MzAwNjY4NTQ4MA==&mid=2651174290&idx=1&sn=288518f030801f4d90878e806546487c&scene=1&srcid=0721NBPW2U9bCAlMyD6IR9uY&key=77421cf58af4a653d7c117042d4629105d3e23d9abedb5952440f749a5e6c0e77bbd74c2df6c99d944325721a8118845&ascene=0&uin=MTQwNzUyMTU%3D&devicetype=iMac+MacBookPro12%2C1+OSX+OSX+10.11.5+build(15F34)&version=11020201&pass_ticket=diBfj8ThlW2WdI9Zac7pAFMne2lk1qs7pLxloon8PbI%3D
[2]:http://bbs.chinaunix.net/thread-3679025-1-1.html
[3]:https://www.linode.com/docs/uptime/monitoring/use-vmstat-to-monitor-system-performance


